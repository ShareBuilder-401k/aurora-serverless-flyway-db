# Aurora Serverless Flyway DB

Aurora Serverless Flyway DB is a template project that is used to setup an [Amazon Aurora Serverless Database](https://aws.amazon.com/rds/aurora/serverless/) that is integrated with [Flyway](https://flywaydb.org/) to manage database migrations. This integration is accomplished through the use of an ECS task along with the help of GitHub Actions.

## Contents
- [Overview](#Overview)
- [Getting Started](#getting-started)

## Overview

This section will give an overview of some of the technologies used for this project.

![aurora-flyway-infrastructure](assets/aurora-flyway-infrastructure.png)

### AWS

#### Amazon Aurora Serverless

[Amazon Aurora Serverless](https://aws.amazon.com/rds/aurora/serverless/) is a database solution that is able to automatically start, stop, and scale capacity up and down based on usage making it a very cost-effective and easy to manage option for running a databse.

#### AWS Fargate

[AWS Fargate](https://aws.amazon.com/fargate/) is a serverless compute engine for containers. With Fargate we are able to run a docker container with flyway from the same VPC that the Amazon Aurora Serverless Database Cluster is in.

#### AWS Secrets Manager

[AWS Secrets Manager](https://aws.amazon.com/secrets-manager/) is a solution to store and protect applications secrets. It is used in this project to store user credentials for the database, a private key to an SSH key pair with the public key set as a Deploy Key on this repository, and the credentials for a Docker Registry. If using GitHub Packages to store the Flyway Docker image generated by the `flyway-build-docker-image-workflow`, the credentials will be from a Personal Access Token to this repo with `repo`, `write:packages`, and `read:packages` permissions.

#### AWS EC2

In order to limit access to this database, an [Amazon EC2](https://aws.amazon.com/ec2) is used as a [bastion host](https://aws.amazon.com/quickstart/architecture/linux-bastion/) or gateway in the same subnet as the Aurora Serverless Database. By establishing an SSH connection to the bastion host, we are then able to connect to the RDS database through localhost port 5432.

### Terraform

[Terraform](https://www.terraform.io/) is an infrastructure as code solution used to provision and manage all of the AWS infrastructure used in this project, other than S3 and Secrets Manager resources. The Terraform files are located in the `infrastructure/` folder by each main component in a subfolder. Available variables and default values can be found in the `variables.tf` files of each subfolder. They can be configured using `<region>.tfvars` files in the `var-files/` folder.

### Flyway

Flyway is an open source tool for managing database migrations. Flyway will search through all files in the `sql/` folder finding any file that matches `V<version>__<Version_Description>.sql` for versioned migrations or `R__<Procedure_name>.sql` for repeatable migrations. Flyway is only concerned with the names of the individual files and does not actually care about the structure. The structure is just for developers to better organize their code.

Versioned migrations are migrations that are executed in order according to their version. This is important to keep in mind when creating a migration that could depend on another migration (ex: Table A column references Table B so the Table A migration would need to have a lower version and be applied first).

Repeatable migrations are migrations that are reapplied every time their checksum changes (every time they are modified). These are good for database objects that can be maintained in a single file in version control, such as stored procedures and bulk inserts. Repeatable migrations are always applied after versioned migrations.

For this project, flyway will search through the `sql/` directory to find all filenames matching either `V<version>__<Version_Description>.sql` for versioned migrations or `R__<Repeatable_Description>.sql` fro repeatable migrations.

### GitHub Actions

[GitHub Actions](https://github.com/features/actions) is a CI/CD solution through GitHub that allows for the creation of workflows for this project. These workflows are used to manage infrastructure using terraform, manage the aurora serverless database through the creation and restoration of database snapshots, trigger a standalone ECS task to run flyway migrations on our database, build the docker image for this repo configured to run flyway from the ECS task, and even generate the database schema as markdown and append it to this `README.md`.

## Getting Started

This section will go over the steps to setup this project and get a database up and running.

# Database Documentation

Created at: 2020-09-30T23:47:43.978Z
Server version: PostgreSQL 12.4 on x86_64-pc-linux-musl, compiled by gcc (Alpine 9.3.0) 9.3.0, 64-bit
## Schema: public

### Tables

#### public.flyway_schema_history

column | comment | type | length | default | constraints | values
--- | --- | --- | --- | --- | --- | ---
**installed_rank** _(pk)_ |  | integer |  |  | NOT NULL |
version |  | character varying | 50 |  |  |
description |  | character varying | 200 |  | NOT NULL |
type |  | character varying | 20 |  | NOT NULL |
script |  | character varying | 1000 |  | NOT NULL |
checksum |  | integer |  |  |  |
installed_by |  | character varying | 100 |  | NOT NULL |
installed_on |  | timestamp without time zone |  | now() | NOT NULL |
execution_time |  | integer |  |  | NOT NULL |
success |  | boolean |  |  | NOT NULL |

#### public.sample

column | comment | type | length | default | constraints | values
--- | --- | --- | --- | --- | --- | ---
**id** _(pk)_ |  | integer |  | nextval('sample_id_seq'::regclass) | NOT NULL |
message |  | character varying | 255 |  |  |
