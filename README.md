# Aurora Serverless Flyway DB

Aurora Serverless Flyway DB is a template project that is used to setup an [Amazon Aurora Serverless Database](https://aws.amazon.com/rds/aurora/serverless/) that is integrated with [Flyway](https://flywaydb.org/) to manage database migrations. This integration is accomplished through the use of an ECS Fargate task along with the help of GitHub Actions.

## Contents
- [Overview](#overview)
  - [AWS](#aws)
  - [Terraform](#terraform)
  - [Flyway](#flyway)
  - [GitHub Actions](#github-actions)
- [Getting Started](#getting-started)
  - [Repository Setup](#repository-setup)
  - [Secrets Manager Setup](#secrets-manager-setup)
  - [GitHub Actions Config Setup](#github-actions-config-setup)

## Overview

This section will give an overview of some of the technologies used for this project.

![aurora-flyway-infrastructure](assets/aurora-flyway-infrastructure.png)

### AWS

#### Amazon Aurora Serverless

[Amazon Aurora Serverless](https://aws.amazon.com/rds/aurora/serverless/) is a database solution that is able to automatically start, stop, and scale capacity up and down based on usage making it a very cost-effective and easy to manage option for running a databse.

#### AWS Fargate

[AWS Fargate](https://aws.amazon.com/fargate/) is a serverless compute engine for containers. With Fargate we are able to run a docker container with flyway from the same VPC that the Amazon Aurora Serverless Database Cluster is in.

#### AWS Secrets Manager

[AWS Secrets Manager](https://aws.amazon.com/secrets-manager/) is a solution to store and protect applications secrets. It is used in this project to store user credentials for the database, a private key to an SSH key pair with the public key set as a Deploy Key on this repository, and the credentials for a Docker Registry. If using GitHub Packages to store the Flyway Docker image generated by the `flyway-build-docker-image-workflow`, the credentials will be from a Personal Access Token to this repo with `repo`, `write:packages`, and `read:packages` permissions.

#### AWS EC2

In order to limit access to this database, an [Amazon EC2](https://aws.amazon.com/ec2) is used as a [bastion host](https://aws.amazon.com/quickstart/architecture/linux-bastion/) or gateway in the same subnet as the Aurora Serverless Database. By establishing an SSH connection to the bastion host, we are then able to connect to the RDS database through localhost port 5432.

### Terraform

[Terraform](https://www.terraform.io/) is an infrastructure as code solution used to provision and manage all of the AWS infrastructure used in this project, other than S3 and Secrets Manager resources. The Terraform files are located in the `infrastructure/` folder by each main component in a subfolder. Available variables and default values can be found in the `variables.tf` files of each subfolder. They can be configured using `<region>.tfvars` files in the `var-files/` folder.

![terraform-folder-structure](assets/terraform-folder-structure.png)

### Flyway

[Flyway](https://flywaydb.org/) is an open source tool for managing database migrations. Flyway will search through all files in the `sql/` folder finding any file that matches `V<version>__<Version_Description>.sql` for versioned migrations or `R__<Procedure_name>.sql` for repeatable migrations. Flyway is only concerned with the names of the individual files and does not actually care about the structure. The structure is just for developers to better organize their code.

Versioned migrations are migrations that are executed in order according to their version. This is important to keep in mind when creating a migration that could depend on another migration (ex: Table A column references Table B so the Table A migration would need to have a lower version and be applied first). Flyway keeps track of the current database version using the `flyway_schema_history` table.

Repeatable migrations are migrations that are reapplied every time their checksum changes (every time they are modified). These are good for database objects that can be maintained in a single file in version control, such as stored procedures and bulk inserts. Repeatable migrations are always applied after versioned migrations.

For this project, flyway will search through the `sql/` directory to find all filenames matching either `V<version>__<Version_Description>.sql` for versioned migrations or `R__<Repeatable_Description>.sql` fro repeatable migrations.

![flyway-folder-structure](assets/flyway-folder-structure.png)

### GitHub Actions

[GitHub Actions](https://github.com/features/actions) is a CI/CD solution through GitHub that allows for the creation of workflows for this project. These workflows are used to manage infrastructure using terraform, manage the aurora serverless database through the creation and restoration of database snapshots, trigger a standalone ECS task to run flyway migrations on our database, build the docker image for this repo configured to run flyway from the ECS task, and even generate the database schema as markdown and append it to this `README.md`.

## Getting Started

This section will go over the steps to setup this project and get a database up and running.

### Repository Setup

1. Above this repository's file list, click the **Use this template** button.
2. Follow the prompts to set the repository owner, name, and visibility and to optionally include all branches if desired.
3. In the new repository, navigate to **Actions** from the top menu bar and click **Enable Actions on this repository**.
4. Navigate to **Settings -> Secrets** and click **New secret**
5. Add a secret for `AWS_ACCESS_KEY_ID` for the AWS account credentials.
6. Repeat step 4 and add a secret for `AWS_SECRET_ACCESS_KEY` for the AWS account credentials.
7. Navigate to **Settings -> Deploy Keys** and click **Add deploy key**
8. In a terminal, run `ssh-keygen -m PEM -t rsa -b 4096 -C "<repository_name> read-repository" -f <file_path>`
   - Example: `ssh-keygen -m PEM -t rsa -b 4096 -C "aurora-serverless-flyway-db read-repository" -f ~/.ssh/aurora-serverless-flyway-db`
9. Back in GitHub, copy the contents of the public key file generated from the `ssh-keygen` command into the **Key** section. The public key file will be in the format of `<file_path>.pub`.
10. Add a title and click **Add key**. Write access is not needed for this deploy key.
11. Click the profile picture in the top right corner and click **Settings**
12. Click **Developer settings** in the settings menu.
13. Select **Personal access tokens** and click **Generate new token**.
14. Select `repo` and `read:packages` scope and click **Generate token**.
15. Copy the generated token and store it in a secure location.

### Secrets Manager Setup

1. Login to the AWS console.
2. Navigate to **Services -> Secrets Manager**.
3. Click **Store a new secret**.
4. Select **Other type of secrets**.
5. Under **Specify the key/value pairs to be stred in this secret**, select **Plaintext** and copy the contents of the private key for the deploy key generated in step 8 of [Repository Setup](#repository-setup).
6. Select and encryption key or use the `DefaultEncryptionKey` and click **Next**.
7. Specify a **Secret name** and **Description** for the secret and click **Next**.
    - I like to name my secrets describing their use separating descriptors by the `@` symbol. Ex: `github@<repo_owner>@<repo_path>@repository-deploy-key`.
8. Select **Disable automatic rotation** and click **Next**.
9. Click **Store**.
10. Repeat steps 3-9 to store the personal access token from step 15 of [Repository Setup](#repository-setup). Instead of storing the value as plaintext, store it as **Secret key/value**. The pairs are:
    - key: `username`, value: the username used to create the personal access token
    - key: `password`, value: the personal access token from the generate token step
      - Example secret name: `github@<github_user>@registry_token`
11. Repeat steps 3-9 to store a username and secure password key value pair for the master credentials of the database.
    - Example secret name: `<db_engine>@<dbname>@<db_table>@<db_user_name>`
      -  Ex: `postgresql@auroradb@master@sqladmin`
12. Repeat steps 3-9 to store username and secure password key value pairs for any additional database users. This process will also be used to add new users during development.
    - The additional users used in the sample sql code are:
      - `postgresql@auroradb@master@read_only`
      - `postgresql@auroradb@sample@sample_application`

### GitHub Actions Config Setup

This project uses a `config.json` file to configure values for the GitHub Actions Workflow. Since GitHub Actions does not currently support manually invoking workflows from the GitHub actions console, `trigger_workflow.sh`, a script to invoke workflows through the use of [`repository_dispatch`](https://docs.github.com/en/free-pro-team@latest/actions/reference/events-that-trigger-workflows#repository_dispatch) events, has been included with the project. This script will parse `config.json` to retrieve values to build the HTTP request and payload to generate the `repository_dispatch` event.

The `config.json` values are as follows:

| property | description | required | default |
| -------- | ----------- | -------- | ------- |
| `flywayVersion` | The version of the docker image generated by the `build-flyway-docker-image-workflow` to be used by the ECS Fargate Task | true | `"0.0.0"` |
| `githubOwner` | The owner of the GitHub repository. Could be a user or organization. | true | `"CHANGE ME"` |
| `githubRepo` | The path of the GitHub repository. Does not include owner. | true | `"CHANGE ME"` |
| `gitbotEmail` | The email used to make automated commits to this repo (Updating `app_version` in `infrastructure/flyway-fargate-task/var-files/*.tfvars` on new flyway image build, updating metadata reference on new RDS snapshot creation, or updating `README.md` with the database schema from running flyway on `sql/`) | false | `"aurora.gitbot@example.com"` |
| `gitbotName` | The name used to make automated commits to this repo | false | `"aurora-gitbot"` |
| `githubTokenName` | The environment variable name storing a GitHub Personal Access Token with `repo` scope to invoke GitHub actions using the `trigger_workflow.sh` script. | true | `"GITHUB_AURORA_ACTIONS_TOKEN"` |
| `dockerRegistry` | The host name of the docker registry where the image for this repository to run flyway from ECS will be stored. | true | `"docker.pkg.github.com"` |
| `dockerOwner` | The owner or organization where the docker image will be stored in the docker registry | true | `"CHANGE ME"` |
| `dockerRepo` | The repo path where the docker image will be stored in the docker registry (does not include owner) | true | `"CHANGE ME"` |
| `infrastructure` | An object with properties for each region to configure values to be used by GitHub actions. These values should match what is configured in the terrafrom files in the `infrastructure` folder. Multiple regions may be present. | true | Object with us-west-2 configuration object |
| `infrastructure["<region>"]` | Ex: `infrastructure["us-west-2"]`. An object with properties for configuring infrastructure in the us-west-2 region. | true | An object with properties for infrastructure in the us-west-2 region |
| `infrastructure["<region>"].terraformBucket` | The S3 bucket used to store terraform state files for the AWS infrastructure. | true | `"CHANGE ME"` |
| `infrastructure["<region>"].auroraDB` | An object with properties for the Aurora DB infrastructure generated by terraform. | true | An object with values matching default terraform values |
| `infrastructure["<region>"].auroraDB.dbClusterName` | The name of the Aurora DB cluster | true | `"auroradb-cluster"` |
| `infrastructure["<region>"].auroraDB.dbSubnetGroup` | The name of the DB subnet group used by the Aurora DB cluster | true | `"auroradb-subnet-group"` |
| `infrastructure["<region>"].auroraDB.vpcSecurityGroups` | A comma separated list of VPC security groups assigned to the Aurora DB cluster. | true | `"auroradb-sg"` |
| `infrastructure["<region>"].flywayTask` | An object with properties for the Flyway ECS Task Definition infrastructure generated by terraform. | true | An object with values matching default terraform values. |
| `infrastructure["<region>"].flywayTask.taskDefinitionFamily` | The name of the flyway Fargate Task Definition Family | true | `"flyway-migration-family"` |
| `infrastructure["<region>"].flywayTask.taskLaunchType` | The launch type for the flyway Task Definition. This project is configured for FARGATE but can be modified for use with EC2 Launch Type. | true | `"FARGATE"` |
| `infrastructure["<region>"].flywayTask.taskCluster` | The name of the ECS Cluster to launch the flyway task in. | true | `"ecs-cluster"` |
| `infrastructure["<region>"].flywayTask.taskSubnets` | A comma separated list of subnets in which the flyway task can be launched. | true | `"default-us-west-2a,default-us-west-2b,default-us-west-2c"` |
| `infrastructure["<region>"].flywayTask.taskSecurityGroups` | A comma separated list of security groups to assign to the flyway task | true | `"flyway-fargate-sg,auroradb-sg"` |
| `infrastructure["<region>"].flywayTask.isPublicSubnet` | Are the subnets in which the flyway task is being launched public? (Does a Public IP address need to be assigned?) | true | `true` |
| `infrastructure["<region>"].bastion` | An object with properties for the bastion host EC2 instance generated by terraform (if one is used) | false | An object with values matching default terraform values for the bastion host EC2 instance |
| `infrastructure["<region>"].bastion.bastionHostName` | The name of the bastion host EC2 instance | false | `"bastion-host"` |
| `infrastructure["<region>"].bastion.privateKeyBucket` | The name of the S3 bucket where the private SSH key for the bastion host EC2 instance is stored. | false | `"CHANGE ME"` |
| `infrastructure["<region>"].bastion.privateKeyPath` | The path in the S3 bucket to the private SSH key for the bastion host EC2 instance | false | `"private/bastion-host-key"` |


# Database Documentation

Created at: 2020-09-30T23:47:43.978Z
Server version: PostgreSQL 12.4 on x86_64-pc-linux-musl, compiled by gcc (Alpine 9.3.0) 9.3.0, 64-bit
## Schema: public

### Tables

#### public.flyway_schema_history

column | comment | type | length | default | constraints | values
--- | --- | --- | --- | --- | --- | ---
**installed_rank** _(pk)_ |  | integer |  |  | NOT NULL |
version |  | character varying | 50 |  |  |
description |  | character varying | 200 |  | NOT NULL |
type |  | character varying | 20 |  | NOT NULL |
script |  | character varying | 1000 |  | NOT NULL |
checksum |  | integer |  |  |  |
installed_by |  | character varying | 100 |  | NOT NULL |
installed_on |  | timestamp without time zone |  | now() | NOT NULL |
execution_time |  | integer |  |  | NOT NULL |
success |  | boolean |  |  | NOT NULL |

#### public.sample

column | comment | type | length | default | constraints | values
--- | --- | --- | --- | --- | --- | ---
**id** _(pk)_ |  | integer |  | nextval('sample_id_seq'::regclass) | NOT NULL |
message |  | character varying | 255 |  |  |
